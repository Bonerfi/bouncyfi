<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaos Lab: Speed Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi-player-js@2.0.16/browser/midiplayer.min.js"></script>
    <style>
        :root { --accent: #00f2ff; --panel-bg: rgba(10, 10, 15, 0.98); }
        body { margin: 0; background: #000; color: #eee; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; }
        #container { position: relative; width: 1080px; height: 1920px; max-width: 100%; max-height: 100%; display: flex; justify-content: center; align-items: center; }
        canvas { position: absolute; max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        
        #audio-unlock { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; cursor: pointer; text-align: center; }
        #panel { position: absolute; top: 10px; left: 10px; width: 240px; background: var(--panel-bg); padding: 15px; border-radius: 12px; border: 1px solid #333; backdrop-filter: blur(15px); max-height: 85vh; overflow-y: auto; z-index: 100; font-size: 11px; }
        #toggle-ui { position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 25px; background: var(--accent); border: none; font-weight: bold; z-index: 101; cursor: pointer; opacity: 0.7; color: #000; }
        
        h4 { margin: 12px 0 5px 0; color: var(--accent); text-transform: uppercase; font-size: 9px; letter-spacing: 1px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .section { margin-bottom: 10px; }
        label { display: flex; justify-content: space-between; margin-bottom: 4px; color: #888; align-items: center; }
        span { color: var(--accent); font-family: monospace; }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        input[type="color"] { width: 40px; height: 20px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; }
        #palette-list { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 5px; }
        .color-item { position: relative; width: 28px; height: 28px; border-radius: 4px; border: 1px solid #444; overflow: hidden; }
        .color-item input { position: absolute; top: -5px; left: -5px; width: 40px; height: 40px; }
        .btn { background: var(--accent); color: #000; border: none; padding: 8px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-rec { background: #ff4444; color: white; }
    </style>
</head>
<body>

<div id="audio-unlock" onclick="unlockAudio()">
    <h2 style="color:var(--accent)">INITIALIZE ENGINE</h2>
    <p>Tap to start</p>
</div>

<button id="toggle-ui" onclick="toggleUI()">UI</button>

<div id="panel">
    <button id="record-btn" class="btn btn-rec">RENDER PRO VIDEO</button>
    <button class="btn" style="background: #333; color: white; margin-top: 8px;" onclick="document.getElementById('midi-upload').click()">LOAD MIDI FILE</button>
    <div id="midi-status" style="font-size: 8px; color: #00ff00; text-align: center; margin-top: 3px;">No MIDI</div>
    <input type="file" id="midi-upload" accept=".mid,.midi" style="display:none">

    <h4>Arena & Pulse</h4>
    <div class="section">
        <label>Arena Color <input type="color" id="arena-color" value="#333333"></label>
        <label>Sync with Ball <input type="checkbox" id="sync-arena" checked></label>
        <label>Arena Growth/Hit <span id="v-arenagrow">0</span></label>
        <input type="range" id="arena-grow" min="-10" max="10" step="0.5" value="0">
        <label>Shockwave Power <span id="v-pulse">60</span></label>
        <input type="range" id="pulse-strength" min="0" max="150" step="1" value="60">
    </div>

    <h4>Ball Styling</h4>
    <div class="section">
        <label>Outline Color <input type="color" id="ball-stroke" value="#ffffff"></label>
        <label>Thickness <span id="v-swidth">3</span></label>
        <input type="range" id="stroke-width" min="0" max="25" step="1" value="3">
        <label>Glow Power <span id="v-glow">40</span></label>
        <input type="range" id="glow-power" min="0" max="100" step="1" value="40">
    </div>

    <h4>Physics & Escalation</h4>
    <div class="section">
        <label>Gravity <span id="v-grav">0.30</span></label>
        <input type="range" id="grav" min="0" max="1" step="0.01" value="0.30">
        <label>Bounciness <span id="v-bounce">0.98</span></label>
        <input type="range" id="bounce" min="0.5" max="1.1" step="0.01" value="0.98">
        <label>Speed Mult <span id="v-speed">x1.000</span></label>
        <input type="range" id="speed-mult" min="0.95" max="1.05" step="0.001" value="1.000">
        <label>Ball Size Inc <span id="v-grow">+0.00</span></label>
        <input type="range" id="grow-amt" min="-2" max="3" step="0.01" value="0.00">
    </div>

    <h4>Environment</h4>
    <div class="section">
        <label>Persistence <span id="v-persist">0.10</span></label>
        <input type="range" id="trail-persist" min="0" max="1" step="0.001" value="0.10">
        <label>Color Palette</label>
        <div id="palette-list"></div>
        <button class="btn" style="font-size: 9px; padding: 3px;" onclick="addColor()">+ Add Color</button>
    </div>

    <button class="btn" onclick="resetSim()" style="margin-top:10px">RESET SIMULATION</button>
</div>

<div id="container">
    <canvas id="trailCanvas"></canvas>
    <canvas id="mainCanvas"></canvas>
</div>

<script>
const trailCanvas = document.getElementById('trailCanvas');
const mainCanvas = document.getElementById('mainCanvas');
const tctx = trailCanvas.getContext('2d');
const mctx = mainCanvas.getContext('2d');
const container = document.getElementById('container');

trailCanvas.width = mainCanvas.width = 1080;
trailCanvas.height = mainCanvas.height = 1920;

const centerX = 540, centerY = 960;
let currentArenaRadius = 475;
let midiNotes = [], noteIndex = 0, colorTimer = 0, synth, audioDest;
let isSimRunning = false, arenaPulse = 0, bounceCount = 0;
let speedHistory = new Array(150).fill(0); // Holds velocity magnitudes

const settings = {
    bgColor: '#050505',
    palette: ['#00f2ff', '#ff00ff', '#ffff00'],
    cycleSpeed: 0.005,
    persistence: 0.1,
    gravity: 0.3,
    bounce: 0.98,
    speedMult: 1.0,
    sizeInc: 0,
    ballStroke: '#ffffff',
    strokeWidth: 3,
    glowPower: 40,
    defaultSize: 30,
    initialSpeed: 10,
    arenaColor: '#333333',
    syncArena: true,
    pulseStrength: 60,
    arenaGrowAmt: 0
};

const ball = { x: centerX, y: centerY, vx: 0, vy: 0, radius: 30, glow: 0, currentColor: '#00f2ff' };

async function unlockAudio() {
    await Tone.start();
    audioDest = Tone.getContext().createMediaStreamDestination();
    synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
    }).connect(audioDest).toDestination();
    document.getElementById('audio-unlock').style.display = 'none';
    resetSim(); loop();
}

container.addEventListener('mousedown', (e) => {
    if(!isSimRunning) {
        const rect = container.getBoundingClientRect();
        const scaleX = 1080 / rect.width;
        const scaleY = 1920 / rect.height;
        ball.x = (e.clientX - rect.left) * scaleX;
        ball.y = (e.clientY - rect.top) * scaleY;
        ball.vx = settings.initialSpeed; ball.vy = settings.initialSpeed * 0.5;
        isSimRunning = true;
        speedHistory.fill(0);
    }
});

function resetSim() {
    isSimRunning = false; arenaPulse = 0; bounceCount = 0;
    currentArenaRadius = 475;
    ball.x = centerX; ball.y = centerY; ball.radius = settings.defaultSize;
    tctx.fillStyle = settings.bgColor; tctx.fillRect(0, 0, 1080, 1920);
    mctx.clearRect(0,0,1080,1920);
    speedHistory.fill(0);
}

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
    return {r, g, b};
}

function lerpColor(c1, c2, t) {
    const r1 = parseInt(c1.substr(1,2),16), g1 = parseInt(c1.substr(3,2),16), b1 = parseInt(c1.substr(5,2),16);
    const r2 = parseInt(c2.substr(1,2),16), g2 = parseInt(c2.substr(3,2),16), b2 = parseInt(c2.substr(5,2),16);
    return `rgb(${Math.round(r1+(r2-r1)*t)}, ${Math.round(g1+(g2-g1)*t)}, ${Math.round(b1+(b2-b1)*t)})`;
}

function update() {
    if(!isSimRunning) return;
    ball.vy += settings.gravity;
    ball.x += ball.vx; ball.y += ball.vy;

    // Track Speed for Graph
    const currentSpeed = Math.sqrt(ball.vx**2 + ball.vy**2);
    speedHistory.push(currentSpeed);
    speedHistory.shift();

    if (settings.palette.length > 1) {
        colorTimer += settings.cycleSpeed;
        const t = colorTimer % settings.palette.length;
        const i = Math.floor(t), next = (i + 1) % settings.palette.length;
        ball.currentColor = lerpColor(settings.palette[i], settings.palette[next], t - i);
    }

    const dx = ball.x - centerX, dy = ball.y - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist + ball.radius > currentArenaRadius) {
        const nx = dx / dist, ny = dy / dist;
        const dot = ball.vx * nx + ball.vy * ny;
        ball.vx = (ball.vx - 2 * dot * nx) * settings.bounce;
        ball.vy = (ball.vy - 2 * dot * ny) * settings.bounce;
        
        currentArenaRadius = Math.max(100, Math.min(530, currentArenaRadius + settings.arenaGrowAmt));
        ball.x = centerX + nx * (currentArenaRadius - ball.radius);
        ball.y = centerY + ny * (currentArenaRadius - ball.radius);
        ball.radius = Math.max(5, ball.radius + settings.sizeInc);
        ball.vx *= settings.speedMult; ball.vy *= settings.speedMult;

        if (midiNotes.length > 0) {
            synth.triggerAttackRelease(midiNotes[noteIndex], "16n");
            noteIndex = (noteIndex + 1) % midiNotes.length;
        }
        ball.glow = 1; arenaPulse = 1; bounceCount++;
    }
    ball.glow *= 0.9; arenaPulse *= 0.94;
}

function draw() {
    const rgb = hexToRgb(settings.bgColor);
    tctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${settings.persistence})`;
    tctx.fillRect(0, 0, 1080, 1920);

    if(isSimRunning) {
        tctx.save();
        tctx.shadowBlur = ball.glow * settings.glowPower; tctx.shadowColor = settings.ballStroke;
        tctx.beginPath(); tctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
        tctx.fillStyle = ball.currentColor; tctx.fill();
        if (settings.strokeWidth > 0) {
            tctx.strokeStyle = settings.ballStroke;
            tctx.lineWidth = settings.strokeWidth;
            tctx.stroke();
        }
        tctx.restore();
    }

    mctx.clearRect(0,0,1080,1920);
    const cArena = settings.syncArena ? ball.currentColor : settings.arenaColor;
    
    // Arena Ring
    mctx.save();
    mctx.beginPath(); mctx.arc(centerX, centerY, currentArenaRadius, 0, Math.PI*2);
    mctx.strokeStyle = cArena; mctx.lineWidth = 15; mctx.globalAlpha = 0.8;
    mctx.stroke();

    // Pulse Effect
    if (arenaPulse > 0.01) {
        mctx.beginPath();
        const pR = currentArenaRadius + ((1 - arenaPulse) * settings.pulseStrength);
        mctx.arc(centerX, centerY, pR, 0, Math.PI*2);
        mctx.lineWidth = 5 + (arenaPulse * 10); mctx.globalAlpha = arenaPulse * 0.4;
        mctx.stroke();
    }
    mctx.restore();

    // --- ESCALATION GRAPH ---
    const gx = 100, gy = 1750, gw = 880, gh = 120;
    mctx.save();
    mctx.fillStyle = "rgba(255,255,255,0.05)";
    mctx.fillRect(gx, gy, gw, gh);
    
    // Draw Speed Mountain
    mctx.beginPath();
    mctx.strokeStyle = cArena;
    mctx.lineWidth = 4;
    mctx.lineJoin = "round";
    
    // Auto-scale height based on max speed in history
    const maxS = Math.max(40, ...speedHistory);
    
    for(let i=0; i<speedHistory.length; i++) {
        const px = gx + (i / (speedHistory.length - 1)) * gw;
        const py = gy + gh - (speedHistory[i] / maxS * gh);
        if(i === 0) mctx.moveTo(px, py); else mctx.lineTo(px, py);
    }
    mctx.stroke();

    // Stats
    mctx.fillStyle = "white";
    mctx.font = "bold 40px Courier New";
    mctx.textAlign = "left";
    mctx.fillText(`VELOCITY TRACKER`, gx, gy - 20);
    mctx.textAlign = "right";
    mctx.fillText(`HITS: ${bounceCount}`, gx + gw, gy - 20);
    mctx.restore();
}

function loop() { update(); draw(); requestAnimationFrame(loop); }

function renderPalette() {
    const list = document.getElementById('palette-list');
    list.innerHTML = '';
    settings.palette.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = 'color-item';
        div.innerHTML = `<input type="color" value="${c}" oninput="settings.palette[${i}]=this.value"><button style="position:absolute;top:0;right:0;background:none;border:none;color:white;cursor:pointer;font-size:8px;" onclick="settings.palette.splice(${i},1);renderPalette()">Ã—</button>`;
        list.appendChild(div);
    });
}
function addColor() { settings.palette.push('#ffffff'); renderPalette(); }

// UI Wire-up
document.getElementById('arena-grow').oninput = (e) => { settings.arenaGrowAmt = parseFloat(e.target.value); document.getElementById('v-arenagrow').innerText = settings.arenaGrowAmt; };
document.getElementById('pulse-strength').oninput = (e) => { settings.pulseStrength = parseInt(e.target.value); document.getElementById('v-pulse').innerText = settings.pulseStrength; };
document.getElementById('grav').oninput = (e) => { settings.gravity = parseFloat(e.target.value); document.getElementById('v-grav').innerText = settings.gravity.toFixed(2); };
document.getElementById('bounce').oninput = (e) => { settings.bounce = parseFloat(e.target.value); document.getElementById('v-bounce').innerText = settings.bounce.toFixed(2); };
document.getElementById('speed-mult').oninput = (e) => { settings.speedMult = parseFloat(e.target.value); document.getElementById('v-speed').innerText = 'x' + settings.speedMult.toFixed(3); };
document.getElementById('grow-amt').oninput = (e) => { settings.sizeInc = parseFloat(e.target.value); document.getElementById('v-grow').innerText = (settings.sizeInc >= 0 ? '+' : '') + settings.sizeInc.toFixed(2); };
document.getElementById('trail-persist').oninput = (e) => { settings.persistence = parseFloat(e.target.value); document.getElementById('v-persist').innerText = settings.persistence.toFixed(2); };
document.getElementById('bg-color').oninput = (e) => settings.bgColor = e.target.value;
document.getElementById('arena-color').oninput = (e) => settings.arenaColor = e.target.value;
document.getElementById('sync-arena').onchange = (e) => settings.syncArena = e.target.checked;
document.getElementById('ball-stroke').oninput = (e) => settings.ballStroke = e.target.value;
document.getElementById('stroke-width').oninput = (e) => { settings.strokeWidth = parseInt(e.target.value); document.getElementById('v-swidth').innerText = settings.strokeWidth; };
document.getElementById('glow-power').oninput = (e) => { settings.glowPower = parseInt(e.target.value); document.getElementById('v-glow').innerText = settings.glowPower; };

document.getElementById('midi-upload').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const p = new MidiPlayer.Player();
        p.loadArrayBuffer(ev.target.result);
        let noteCollector = [];
        p.getEvents().forEach(track => track.forEach(event => {
            if (event.name === 'Note on' && event.velocity > 0) noteCollector.push({ note: event.noteName, tick: event.tick });
        }));
        noteCollector.sort((a, b) => a.tick - b.tick);
        midiNotes = noteCollector.map(n => n.note);
        document.getElementById('midi-status').innerText = `Loaded ${midiNotes.length} notes`;
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

function toggleUI() {
    const p = document.getElementById('panel');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

renderPalette();
</script>
</body>
</html>
