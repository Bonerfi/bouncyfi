<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaos Lab: Outline Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi-player-js@2.0.16/browser/midiplayer.min.js"></script>
    <style>
        :root { --accent: #00f2ff; --panel-bg: rgba(10, 10, 15, 0.98); }
        body { margin: 0; background: #000; color: #eee; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #audio-unlock { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; cursor: pointer; }
        #panel { position: absolute; top: 10px; left: 10px; width: 230px; background: var(--panel-bg); padding: 15px; border-radius: 12px; border: 1px solid #333; z-index: 100; font-size: 11px; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .btn { background: var(--accent); color: #000; border: none; padding: 10px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-rec { background: #ff4444; color: #fff; }
        h4 { margin: 15px 0 5px 0; color: var(--accent); text-transform: uppercase; font-size: 10px; border-bottom: 1px solid #333; }
        label { display: flex; justify-content: space-between; margin-top: 8px; color: #888; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }
        input[type="color"] { width: 100%; height: 25px; border: none; background: #222; cursor: pointer; }
    </style>
</head>
<body>

<div id="audio-unlock" onclick="unlockAudio()">
    <h2 style="color:var(--accent)">ACTIVATE RENDERER</h2>
    <p>Tap to start Physics & Ball Stylizer</p>
</div>

<div id="panel">
    <button id="record-btn" class="btn btn-rec">RENDER VIDEO + AUDIO</button>
    
    <button class="btn" style="background: #333; color: white; margin-top: 10px;" onclick="document.getElementById('midi-upload').click()">LOAD MIDI</button>
    <input type="file" id="midi-upload" accept=".mid,.midi" style="display:none">

    <h4>Ball Style</h4>
    <label>Fill Color</label>
    <input type="color" id="ball-fill" value="#00f2ff">
    
    <label>Outline Color</label>
    <input type="color" id="ball-stroke" value="#ffffff">
    
    <label>Outline Width <span id="v-swidth">3</span></label>
    <input type="range" id="stroke-width" min="0" max="20" step="1" value="3">

    <label>Glow Power <span id="v-glow">30</span></label>
    <input type="range" id="glow-power" min="0" max="100" step="1" value="30">

    <h4>Physics</h4>
    <label>Gravity <span id="v-grav">0.30</span></label>
    <input type="range" id="grav" min="0" max="1" step="0.01" value="0.30">
    
    <label>Bounciness <span id="v-bounce">0.98</span></label>
    <input type="range" id="bounce" min="0.5" max="1.1" step="0.01" value="0.98">

    <label>Trail Persistence</label>
    <input type="range" id="trail-persist" min="0" max="1" step="0.001" value="0.10">

    <button class="btn" onclick="resetSim()" style="margin-top:15px">RESET</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = 1080; canvas.height = 1920;
const centerX = 540, centerY = 960, arenaRadius = 475;

let midiNotes = [], noteIndex = 0, synth, audioDest;
const settings = { 
    persistence: 0.1, 
    gravity: 0.3, 
    bounce: 0.98,
    ballFill: '#00f2ff',
    ballStroke: '#ffffff',
    strokeWidth: 3,
    glowPower: 30
};
const ball = { x: centerX, y: centerY, vx: 10, vy: 5, radius: 30, glow: 0 };

async function unlockAudio() {
    await Tone.start();
    audioDest = Tone.getContext().createMediaStreamDestination();
    synth = new Tone.PolySynth(Tone.Synth).connect(audioDest).toDestination();
    document.getElementById('audio-unlock').style.display = 'none';
    resetSim(); loop();
}

function resetSim() {
    ball.x = centerX; ball.y = centerY; ball.vx = 10; ball.vy = 5;
    ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, 1080, 1920);
}

function update() {
    ball.vy += settings.gravity;
    ball.x += ball.vx; ball.y += ball.vy;
    const dx = ball.x - centerX, dy = ball.y - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist + ball.radius > arenaRadius) {
        const nx = dx / dist, ny = dy / dist;
        const dot = ball.vx * nx + ball.vy * ny;
        ball.vx = (ball.vx - 2 * dot * nx) * settings.bounce;
        ball.vy = (ball.vy - 2 * dot * ny) * settings.bounce;
        ball.x = centerX + nx * (arenaRadius - ball.radius);
        ball.y = centerY + ny * (arenaRadius - ball.radius);

        if (midiNotes.length > 0 && synth) {
            synth.triggerAttackRelease(midiNotes[noteIndex], "8n");
            noteIndex = (noteIndex + 1) % midiNotes.length;
        }
        ball.glow = 1;
    }
    ball.glow *= 0.9;
}

function draw() {
    ctx.fillStyle = `rgba(5, 5, 5, ${settings.persistence})`;
    ctx.fillRect(0, 0, 1080, 1920);

    // Arena
    ctx.beginPath(); ctx.arc(centerX, centerY, arenaRadius, 0, Math.PI*2);
    ctx.strokeStyle = '#333'; ctx.lineWidth = 15; ctx.stroke();

    // Ball Render
    ctx.save();
    ctx.shadowBlur = ball.glow * settings.glowPower;
    ctx.shadowColor = settings.ballStroke;
    
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
    
    // Fill
    ctx.fillStyle = settings.ballFill;
    ctx.fill();
    
    // Outline (The New Custom Part)
    if (settings.strokeWidth > 0) {
        ctx.strokeStyle = settings.ballStroke;
        ctx.lineWidth = settings.strokeWidth;
        ctx.stroke();
    }
    
    ctx.restore();
}

function loop() { update(); draw(); requestAnimationFrame(loop); }

// Renderer logic
let mediaRecorder;
let recordedChunks = [];
const recordBtn = document.getElementById('record-btn');

recordBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recordBtn.innerText = "RENDER VIDEO + AUDIO";
    } else {
        recordedChunks = [];
        const combinedStream = new MediaStream([
            ...canvas.captureStream(60).getVideoTracks(),
            ...audioDest.stream.getAudioTracks()
        ]);
        const mimeType = MediaRecorder.isTypeSupported('video/mp4') ? 'video/mp4' : 'video/webm';
        mediaRecorder = new MediaRecorder(combinedStream, { mimeType, videoBitsPerSecond: 8000000 });
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
            const blob = new Blob(recordedChunks, { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `chaos_custom_${Date.now()}.${ext}`;
            a.click();
        };
        mediaRecorder.start();
        recordBtn.innerText = "STOP & COMPILE";
    }
};

// UI Listeners
document.getElementById('midi-upload').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const p = new MidiPlayer.Player();
        p.loadArrayBuffer(ev.target.result);
        let notes = [];
        p.getEvents().forEach(t => {
            t.filter(ev => ev.name === 'Note on' && ev.velocity > 0).forEach(ev => notes.push(ev.noteName));
        });
        midiNotes = notes;
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

document.getElementById('ball-fill').oninput = (e) => settings.ballFill = e.target.value;
document.getElementById('ball-stroke').oninput = (e) => settings.ballStroke = e.target.value;
document.getElementById('stroke-width').oninput = (e) => { settings.strokeWidth = parseInt(e.target.value); document.getElementById('v-swidth').innerText = settings.strokeWidth; };
document.getElementById('glow-power').oninput = (e) => { settings.glowPower = parseInt(e.target.value); document.getElementById('v-glow').innerText = settings.glowPower; };
document.getElementById('grav').oninput = (e) => { settings.gravity = parseFloat(e.target.value); document.getElementById('v-grav').innerText = settings.gravity; };
document.getElementById('bounce').oninput = (e) => { settings.bounce = parseFloat(e.target.value); document.getElementById('v-bounce').innerText = settings.bounce; };
document.getElementById('trail-persist').oninput = (e) => settings.persistence = parseFloat(e.target.value);

</script>
</body>
</html>
